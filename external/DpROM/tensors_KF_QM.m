

function [K,D,M,fk,fd,fm,g] = tensors_KF_QM(qmt,Phi,Theta,fext,q,qd,qdd)
% function to use for time integration (all terms, are included)

fk = qmt.K.Q2*q + ttsv(qmt.K.Q3,  q, -1) + ttsv(qmt.K.Q4, q,-1) + ...
    ttsv(qmt.K.Q5, q,-1) + ttsv(qmt.K.Q6, q,-1) + ttsv(qmt.K.Q7, q,-1) +...
    ttsv(qmt.K.Q8, q,-1);
Kt = qmt.K.Q2 + ttsv(qmt.K.Q3t, q, -2) + ttsv(qmt.K.Q4t,q,-2) + ...
    ttsv(qmt.K.Q5t,q,-2) + ttsv(qmt.K.Q6t,q,-2) + ttsv(qmt.K.Q7t,q,-2) +...
    ttsv(qmt.K.Q8t,q,-2) + ...
    einsum('IkjJ,jK,kL->IJKL',qmt.M.M4 + permute(qmt.M.M4,[1 4 3 2]),qdd,q) + ...
    einsum('IJjk,jK,kL->IJK',qmt.M.M4,qd,qd) + ...
    einsum('IiJ,iK->IJK',qmt.M.M3a + permute(qmt.M.M3b,[1 3 2]),qdd) + ...
    einsum('IiJ,iK->IJK',qmt.C.C3a + permute(qmt.C.C3b,[1 3 2]),qd) + ...
    einsum('IkjJ,jK,kL->IJKL',qmt.C.C4 + permute(qmt.C.C4,[1 4 3 2]),qd,q);

% % WITH TERMS UP TO ORDER 3 (q*q*q)
% fk = qmt.K.Q2*q + ttsv(qmt.K.Q3,  q, -1) + ttsv(qmt.K.Q4, q,-1);
% Kt = qmt.K.Q2 + ttsv(qmt.K.Q3t, q, -2) + ttsv(qmt.K.Q4t,q,-2) + ...
%     einsum('IkjJ,jK,kL->IJKL',qmt.M.M4 + permute(qmt.M.M4,[1 4 3 2]),qdd,q) + ...
%     einsum('IJjk,jK,kL->IJK',qmt.M.M4,qd,qd) + ...
%     einsum('IiJ,iK->IJK',qmt.M.M3a + permute(qmt.M.M3b,[1 3 2]),qdd) + ...
%     einsum('IiJ,iK->IJK',qmt.C.C3a + permute(qmt.C.C3b,[1 3 2]),qd) + ...
%     einsum('IkjJ,jK,kL->IJKL',qmt.C.C4 + permute(qmt.C.C4,[1 4 3 2]),qd,q);

fd = qmt.C.C2*qd + einsum('IJK,JL,KM->ILM', qmt.C.C3a, qd, q) + ...
    einsum('IJK,JL,KM->ILM', qmt.C.C3b, q, qd) + ...
    einsum('IJKL,JM,KN,LO->IMNO',qmt.C.C4,q,qd,q);
Dt = qmt.C.C2 + ...
    einsum('IiJk,iK,jL->IJKL',qmt.M.M4 + permute(qmt.M.M4,[1 2 4 3]),q,qd) + ...
    einsum('IJk,kL->IJK',qmt.M.M3a + permute(qmt.M.M3b,[1 3 2]),qd) + ...
    einsum('IJj,jK->IJK',qmt.C.C3a + permute(qmt.C.C3b,[1 3 2]), q) + ...
    einsum('IjJk,jK,kL->IJKL',qmt.C.C4,q,q);

fm = qmt.M.M2*qdd + einsum('Ijk,jJ,kK->IJK', qmt.M.M3a, qdd, q) + ...
    einsum('Ijk,jJ,kK->IJK', qmt.M.M3a, qd, qd) + ...
    einsum('Ijk,jJ,kK->IJK', qmt.M.M3b, q, qdd) + ...
    einsum('Ijkl,jJ,kK,lL->IJKL', qmt.M.M4, q, qdd, q) + ...
    einsum('Ijkl,jJ,kK,lL->IJKL', qmt.M.M4, q, qd, qd);
Mt = qmt.M.M2 + einsum('IiJk,iK,kL->IJKL',qmt.M.M4, q, q) + ...
    einsum('IJk,kK->IJK',qmt.M.M3a + permute(qmt.M.M3b,[1 3 2]),q);

T = Phi + einsum('IJi,iK->IJK',Theta,q);
g = T'*fext;

K = Kt - einsum('iIJ,iK->IJK',Theta,fext);
D = Dt;
M = Mt;