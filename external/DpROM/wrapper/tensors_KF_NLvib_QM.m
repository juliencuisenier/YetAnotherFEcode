
function [dfnl,fnl] = tensors_KF_NLvib_QM(qmt,Phi,Theta,fext,q,qd,qdd)
% NB: in NLvib, the nonlinear function must contain ONLY the nonlinear
% terms (i.e. WITHOUT the linear ones)

fk = ttsv(qmt.K.Q3,  q, -1) + ttsv(qmt.K.Q4, q,-1) + ...
    ttsv(qmt.K.Q5, q,-1) + ttsv(qmt.K.Q6, q,-1) + ttsv(qmt.K.Q7, q,-1) +...
    ttsv(qmt.K.Q8, q,-1);
Kt = ttsv(qmt.K.Q3t, q, -2) + ttsv(qmt.K.Q4t,q,-2) + ...
    ttsv(qmt.K.Q5t,q,-2) + ttsv(qmt.K.Q6t,q,-2) + ttsv(qmt.K.Q7t,q,-2) +...
    ttsv(qmt.K.Q8t,q,-2) + ...
    einsum('IkjJ,jK,kL->IJKL',qmt.M.M4 + permute(qmt.M.M4,[1 4 3 2]),qdd,q) + ...
    einsum('IJjk,jK,kL->IJK',qmt.M.M4,qd,qd) + ...
    einsum('IiJ,iK->IJK',qmt.M.M3a + permute(qmt.M.M3b,[1 3 2]),qdd) + ...
    einsum('IiJ,iK->IJK',qmt.C.C3a + permute(qmt.C.C3b,[1 3 2]),qd) + ...
    einsum('IkjJ,jK,kL->IJKL',qmt.C.C4 + permute(qmt.C.C4,[1 4 3 2]),qd,q);

% % WITH TERMS UP TO ORDER 3 (q*q*q)
% fk = ttsv(qmt.K.Q3,  q, -1) + ttsv(qmt.K.Q4, q,-1);
% Kt = ttsv(qmt.K.Q3t, q, -2) + ttsv(qmt.K.Q4t,q,-2) + ...
%     einsum('IkjJ,jK,kL->IJKL',qmt.M.M4 + permute(qmt.M.M4,[1 4 3 2]),qdd,q) + ...
%     einsum('IJjk,jK,kL->IJK',qmt.M.M4,qd,qd) + ...
%     einsum('IiJ,iK->IJK',qmt.M.M3a + permute(qmt.M.M3b,[1 3 2]),qdd) + ...
%     einsum('IiJ,iK->IJK',qmt.C.C3a + permute(qmt.C.C3b,[1 3 2]),qd) + ...
%     einsum('IkjJ,jK,kL->IJKL',qmt.C.C4 + permute(qmt.C.C4,[1 4 3 2]),qd,q);

fd = einsum('IJK,JL,KM->ILM', qmt.C.C3a, qd, q) + ...
    einsum('IJK,JL,KM->ILM', qmt.C.C3b, q, qd) + ...
    einsum('IJKL,JM,KN,LO->IMNO',qmt.C.C4,q,qd,q);
Ct = einsum('IiJk,iK,jL->IJKL',qmt.M.M4 + permute(qmt.M.M4,[1 2 4 3]),q,qd) + ...
    einsum('IJk,kL->IJK',qmt.M.M3a + permute(qmt.M.M3b,[1 3 2]),qd) + ...
    einsum('IJj,jK->IJK',qmt.C.C3a + permute(qmt.C.C3b,[1 3 2]), q) + ...
    einsum('IjJk,jK,kL->IJKL',qmt.C.C4,q,q);

fm = einsum('Ijk,jJ,kK->IJK', qmt.M.M3a, qdd, q) + ...
    einsum('Ijk,jJ,kK->IJK', qmt.M.M3a, qd, qd) + ...
    einsum('Ijk,jJ,kK->IJK', qmt.M.M3b, q, qdd) + ...
    einsum('Ijkl,jJ,kK,lL->IJKL', qmt.M.M4, q, qdd, q) + ...
    einsum('Ijkl,jJ,kK,lL->IJKL', qmt.M.M4, q, qd, qd);
Mt = einsum('IiJk,iK,kL->IJKL',qmt.M.M4, q, q) + ...
    einsum('IJk,kK->IJK',qmt.M.M3a + permute(qmt.M.M3b,[1 3 2]),q);

T = Phi + einsum('IJi,iK->IJK',Theta,q);
g = (T-Phi)'*fext;

fnl = fk + fd + fm - g;
dfnl.K = Kt - einsum('iIJ,iK->IJK',Theta,fext);
dfnl.C = Ct;
dfnl.M = Mt;








% u = Phi*q + 1/2*einsum('Iij,iJ,jK->IJK',Theta,q,q);
% T = Phi + einsum('IJi,iK->IJK',Theta,q);
% fdamp = (T'*D*T - Phi'*D*Phi)*qd;
% t = einsum('Iij,iJ,jK->IJK',Theta, qd, qd);
% fmass = (T'*M*T - Phi'*M*Phi)*qdd + T'*M*t;
% S = (Ke + D + M);
% S0 = (K + D + M);
% Kt = T'*S*T - Phi'*S0*Phi;